<script>
    document.addEventListener("DOMContentLoaded", function () {
        const loginForm = document.getElementById("loginForm");
        const passwordManagementForm = document.getElementById(
            "passwordManagementForm",
        );
        const passwordResetForm = document.getElementById("passwordResetForm");
        const errorMessageElement = document.getElementById("errorMessage");

        if (loginForm) {
            loginForm.addEventListener("submit", handleLogin);
        }

        if (passwordManagementForm) {
            passwordManagementForm.addEventListener(
                "submit",
                handlePasswordChange,
            );
        }

        if (passwordResetForm) {
            passwordResetForm.addEventListener("submit", handlePasswordReset);
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById("referrer").value;
            const password = document.getElementById("password").value;

            try {
                const response = await fetch("http://localhost:3000/login", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ username, password }),
                });

                const data = await response.json();

                if (data.success) {
                    localStorage.setItem("currentUser", username);
                    window.location.href = "index.html";
                } else {
                    showError(data.message || "Login failed");
                }
            } catch (error) {
                console.error("Login error:", error);
                showError("An error occurred during login");
            }
        }

        async function handlePasswordChange(e) {
            e.preventDefault();
            const username = document.getElementById("referrer").value;
            const newPassword = document.getElementById("newPassword").value;
            const confirmPassword =
                document.getElementById("confirmPassword").value;

            if (newPassword !== confirmPassword) {
                showError("New passwords do not match");
                return;
            }

            try {
                const response = await fetch(
                    "http://localhost:3000/change-password",
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ username, newPassword }),
                    },
                );

                const data = await response.json();

                if (data.success) {
                    showSuccess("Password changed successfully");
                } else {
                    showError(data.message || "Failed to change password");
                }
            } catch (error) {
                console.error("Password change error:", error);
                showError("An error occurred while changing the password");
            }
        }

        async function handlePasswordReset(e) {
            e.preventDefault();
            const username = document.getElementById("resetReferrer").value;
            const newPassword = document.getElementById("resetPassword").value;
            const confirmPassword = document.getElementById(
                "confirmResetPassword",
            ).value;

            if (newPassword !== confirmPassword) {
                showError("New passwords do not match");
                return;
            }

            try {
                const response = await fetch(
                    "http://localhost:3000/reset-password",
                    {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ username, newPassword }),
                    },
                );

                const data = await response.json();

                if (data.success) {
                    showSuccess("Password reset successfully");
                } else {
                    showError(data.message || "Failed to reset password");
                }
            } catch (error) {
                console.error("Password reset error:", error);
                showError("An error occurred while resetting the password");
            }
        }

        function showError(message) {
            errorMessageElement.textContent = message;
            errorMessageElement.style.display = "block";
            errorMessageElement.style.color = "red";
        }

        function showSuccess(message) {
            errorMessageElement.textContent = message;
            errorMessageElement.style.display = "block";
            errorMessageElement.style.color = "green";
        }
    });
</script>
